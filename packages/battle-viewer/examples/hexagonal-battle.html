<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hexagonal Battle Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f0f0;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    battle-viewer {
      width: 100%;
      height: 600px;
      margin: 20px 0;
      border-radius: 8px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #218838;
    }
    
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .play-controls button {
      background: #007bff;
    }
    
    .play-controls button:hover {
      background: #0056b3;
    }
    
    .info {
      background: #e9ecef;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      font-family: monospace;
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "pixi.js": "https://esm.sh/pixi.js@8"
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Hexagonal Battle Example</h1>
    <p>This example demonstrates hexagonal grid combat with character movement and animations.</p>
    
    <battle-viewer id="hexViewer"></battle-viewer>
    
    <div class="controls">
      <button onclick="loadHexBattle()">Load Hex Battle (Lush Valley)</button>
      <button onclick="loadLargeBattle()">Load Large Battle (Tactical Outpost)</button>
    </div>
    
    <div class="play-controls controls">
      <button onclick="playBattle()">▶️ Play</button>
      <button onclick="pauseBattle()">⏸️ Pause</button>
      <button onclick="resetBattle()">⏹️ Reset</button>
    </div>
    
    <div class="info" id="battleInfo">
      Battle Status: Ready to load
    </div>
  </div>

  <script type="module">
    // Import the web component from source (development) or dist (production)
    import { Assets } from "@florelabs/battle-viewer";
    import "@florelabs/battle-viewer";
    // Import terrain presets for examples
    import { createLushValleyTerrain, createTacticalOutpostTerrain } from "./terrain-presets.js";

    // Hexagonal battle data
    const hexBattle = {
      participants: [
        {
          id: "p1",
          name: "Knight",
          initialPosition: { q: 1, r: 2 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "fighter_Idle",
              run: "fighter_run",
              attack: "fighter_combo",
              hit: "fighter_hit"
            },
            facingConfig: {
              defaultFacing: "right",    // Most sprites face right by default
              allowMirroring: true,       // Enable automatic sprite flipping
            }
          },
          weaponId: 1
        },
        {
          id: "p2",
          name: "Archer",
          initialPosition: { q: -2, r: 1 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-sword.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "sword_Idle",
              run: "sword_run",
              attack: "sword_combo",
              hit: "sword_hit"
            }
          },
          weaponId: 2
        },
        {
          id: "e1",
          name: "Orc",
          initialPosition: { q: -1, r: -2 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-pistol.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "pistol_Idle",
              run: "pistol_run",
              attack: "pistol_shot",
              hit: "pistol_hit"
            }
          },
          weaponId: 0
        }
      ],
      turns: [
        {
          id: "turn-1",
          timestamp: Date.now(),
          actions: [
            {
              type: "move",
              actor: "p1",
              path: [
                { q: 0, r: 2 },
                { q: -1, r: 2 },
                { q: -1, r: 1 }
              ]
            }
          ]
        },
        {
          id: "turn-2", 
          timestamp: Date.now() + 2000,
          actions: [
            {
              type: "attack",
              actor: "p1",
              target: "p2",
              position: { q: -1, r: -2 }
            }
          ]
        },
        {
          id: "turn-3",
          timestamp: Date.now() + 3000,
          actions: [
            {
              type: "move",
              actor: "p2",
              path: [
                { q: -2, r: 0 },
                { q: -2, r: -1 }
              ]
            },
            {
              type: "attack", 
              actor: "p2",
              target: "e1",
              position: { q: -1, r: -2 }
            }
          ]
        },
        {
          id: "turn-4",
          timestamp: Date.now() + 5000,
          actions: [
            {
              type: "move",
              actor: "e1",
              path: [
                { q: 0, r: -2 },
                { q: 1, r: -2 },
                { q: 2, r: -3 }
              ]
            },
            {
              type: "attack",
              actor: "e1", 
              target: "p2",
              position: { q: -2, r: -1 }
            },
            {
              type: "attack",
              actor: "e1", 
              target: "p1",
              position: { q: -1, r: 1 }
            }
          ]
        }
      ]
    };

    const largeBattle = {
      participants: [
        {
          id: "p1",
          name: "Knight",
          initialPosition: { q: 4, r: 3 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-sword.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "sword_Idle",
              run: "sword_run",
              attack: "sword_combo",
              hit: "sword_hit"
            },
            facingConfig: {
              defaultFacing: "right",    // Most sprites face right by default
              allowMirroring: true,       // Enable automatic sprite flipping
            }
          },
          weaponId: 1
        },
        {
          id: "p2",
          name: "Archer",
          initialPosition: { q: -4, r: -3 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-sword.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "sword_Idle",
              run: "sword_run",
              attack: "sword_combo",
              hit: "sword_hit"
            }
          },
          weaponId: 2
        },
        {
          id: "e1",
          name: "Orc",
          initialPosition: { q: -6, r: 3 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-pistol.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "pistol_Idle",
              run: "pistol_run",
              attack: "pistol_shot",
              hit: "pistol_hit"
            }
          },
          weaponId: 0
        },
        {
          id: "e2",
          name: "Mage",
          initialPosition: { q: 6, r: -6 },
          spriteConfig: {
            spritesheet: "./atlases/stickman-fighter-pistol.json",
            size: { width: 128, height: 128 },
            anchor: { x: 0.5, y: 0.7 },
            animationMap: {
              idle: "pistol_Idle",
              run: "pistol_run",
              attack: "pistol_shot",
              hit: "pistol_hit"
            }
          },
          weaponId: 0
        }
      ],
      turns: []
    };

    let tileTextures = {}

    const loadAsset = async (url) => {
      try {
          const sheet = await Assets.load(url);
          return sheet
      } catch (error) {
          console.error('Full error:', error);
          throw error;
      }
    };


    // Global functions for buttons
    window.loadHexBattle = async () => {
      const viewer = document.getElementById("hexViewer");
      const radius = 5;
      viewer.setArenaConfig({
        radius,
        tileSize: 32,
        backgroundColor: 0x1a472a,
        // Load both atlas files to support multipack terrain (using relative paths)
        tileSpritesheets: [
          "./atlases/hex_terrain-0.json",
          "./atlases/hex_terrain-1.json"
        ],
        tileTextures,
        tileTextureName: "hexJungle00.png",
        // Use the Lush Valley terrain preset
        terrainMap: createLushValleyTerrain()
      });
      viewer.setBattleData(hexBattle);
      updateInfo("Hex battle loaded with Lush Valley terrain (rivers, forests, mountains, deserts)");
    };

    window.loadLargeBattle = async () => {
      const viewer = document.getElementById("hexViewer");
      const radius = 8;
      viewer.setArenaConfig({
        radius,
        tileSize: 24,
        backgroundColor: 0x2c5aa0,
        // Load both atlas files for consistency (using relative paths)
        tileTextures,
        tileTextureName: "hexPlains00.png",
        // No custom terrain - all default plains
        terrainMap: createTacticalOutpostTerrain()
      });
      viewer.setBattleData(largeBattle);
      updateInfo("Large battle loaded with plain terrain");
    };

    window.customizeArena = () => {
      const viewer = document.getElementById("hexViewer");
      updateInfo("Arena customized: radius=7, tileSize=40");
    };

    window.playBattle = () => {
      const viewer = document.getElementById("hexViewer");
      viewer.setPlaying(true);
      updateInfo("Battle playing...");
    };

    window.pauseBattle = () => {
      const viewer = document.getElementById("hexViewer");
      viewer.setPlaying(false);
      updateInfo("Battle paused");
    };

    window.resetBattle = () => {
      const viewer = document.getElementById("hexViewer");
      viewer.reset();
      updateInfo("Battle reset");
    };

    function updateInfo(message) {
      document.getElementById("battleInfo").textContent = `Battle Status: ${message}`;
    }

    // Auto-load on page load
    window.addEventListener("load", async () => {
      // Set initial arena config, including tiles atlas provided by client
      const viewer = document.getElementById("hexViewer");
      const sheets = await Promise.all(["./atlases/hex_terrain-0.json", "./atlases/hex_terrain-1.json"].map(loadAsset));
      // Merge textures from both sheets
      tileTextures = {
        ...sheets[0].textures,
        ...sheets[1].textures
      };
      loadHexBattle();
    });
  </script>
</body>
</html>